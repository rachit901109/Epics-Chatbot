from flask import Flask, render_template, request
from langchain.llms.huggingface_hub import HuggingFaceHub
from langchain_community.embeddings.huggingface import HuggingFaceEmbeddings
from langchain.memory import ConversationBufferMemory
from langchain_community.vectorstores.faiss import FAISS
from langchain.chains.conversational_retrieval.base import ConversationalRetrievalChain
from dotenv import load_dotenv
import os

load_dotenv()

STORE_DIR = r"vectorstore"

def get_conversation_chain(vector_store, HUGGING_FACE_ACCESS_TOKEN):
    repo_id="google/gemma-1.1-2b-it"
    llm = HuggingFaceHub(repo_id=repo_id, huggingfacehub_api_token=HUGGING_FACE_ACCESS_TOKEN,  model_kwargs={'temperature':0.5, 'max_length':128})
    memory = ConversationBufferMemory(memory_key='chat_history', return_messages=True)
    retriever = vector_store.as_retriever()
    conv_chain = ConversationalRetrievalChain.from_llm(
        llm=llm,
        retriever=retriever,
        memory=memory,
    )
    return conv_chain


app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ['SECRET_KEY']

@app.route('/', methods=["GET", "POST"])
def home():
    if request.method == "POST":
        question = request.form.get("user_input")
        HUGGING_FACE_ACCESS_TOKEN = os.environ["HUGGING_FACE_ACCESS_TOKEN"]

        embedding_model = HuggingFaceEmbeddings(model_name="all-MiniLM-L6-v2", encode_kwargs = {'normalize_embeddings':True})
        faiss = FAISS.load_local(folder_path=STORE_DIR, embeddings=embedding_model, allow_dangerous_deserialization=True)

        conversation_chain = get_conversation_chain(faiss, HUGGING_FACE_ACCESS_TOKEN)
        response = conversation_chain({'question':question}, return_only_outputs=True)
        print(response, type(response), sep='\n')
        return render_template('homepage.html', response=response)
    return render_template('homepage.html')

if __name__=='__main__':
    app.run(
    debug=True, passthrough_errors=True,
    use_debugger=False, use_reloader=False
)


# {'question': "Who was Bharata's mother and what did she resents?",
#  'chat_history': [HumanMessage(content="Who was Bharata's mother and what did she resents?"),
#   AIMessage(content="Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.\n\nwas utterly worn down. He was distressed by the idea of losing his beloved son in his  \n own old age, and could not bring himself to speak to Ram when the young prince came  \n to get his blessing before the coronation.  \n Ram was concerned, 'Have I upset my father'' he wondered, then looking at Kaikeyi's  \n harsh expression, he asked.  \n 'Have I displeased the king' Tell me mother, why does my father looks so dejected''  \n 'Then listen, Ram,' replied Kaikeyi sternly. 'Your father loves you more than even his  \n honour so he hesitates to command you to go into exile for fourteen years, while Bharat  \n is crowned and established king of Ayodhya.' 'Thank you for telling me mother,' Ram  \n said. 'There is no greater virtue than to obey one's parents. I will leave immediately.  \n Bharat will make an able king.'  \n Ram sadly said farewell to his heartbroken father and then went to Queen Kaushaliya,  \n his real mother, to say goodbye to her. He explained how the decision had come about  \n and begged her to be kind to Dasharat who was deeply unhappy at Ram's exile.  \n Although grief-stricken, Kaushaliya agreed with Ram, praying for his happiness in exile.\n\nBharat will make an able king.'  \n Ram sadly said farewell to his heartbroken father and then went to Queen Kaushaliya,  \n his real mother, to say goodbye to her. He explained how the decision had come about  \n and begged her to be kind to Dasharat who was deeply unhappy at Ram's exile.  \n Although grief-stricken, Kaushaliya agreed with Ram, praying for his happiness in exile.  \n Then Ram went to say goodbye to Sita and to comfort her but Sita refused to be  \n separated from her husband.  \n 'If you can to live in hardship away from home and your beloved family,' she said, 'then I  \n will go with you. How can I be happy living in luxury without you'' His brother Lakshman  \n also refused to stay behind and that very day they left the kingdom. Ram led the way,  \n dressed like a holy man, with tangled hair and a leopard skin to cover his body. The  \n only sign that he was a warrior was the quiver of arrows which hung from his shoulder  \n and his precious bow.  \n The three left the city of Ayodhya and made their way across the River Ganges and up  \n into the mountains and forests of the Himalayas where they lived a holy life, filled with  \n fasting and prayer.\n\nRamayana Short Summary  \n  \n Dasharatha is the King of Ayodhya and has three wives and four sons, Rama,  \n Lakshmana, Bharata and Shatrughana. Rama is the ideal and perfect son, and grows  \n up with his brothers. When he comes of age, he marries Sita, the princess of a nearby  \n kingdom. However, Bharata's mother is Kaikeyi, who resents Rama being the crown  \n prince. She calls up a debt that Dasharatha owes her and asks for Rama to be exiled  \n for fourteen years and her son Bharata be made crown prince instead.  \n The devastated Dasharatha has no choice and Rama prepares to leave for exile. Sita  \n and Lakshmana will not leave his side however and follow him into the forest. While in  \n the forest, Surphanaka, a female rakshasi (demoness) becomes enamored of Rama  \n and is wounded by Lakshmana while trying to kill Sita. She flees to her brother Khara  \n and asks him to avenge her. However, Khara and his army are defeated by Rama and  \n Lakshmana, and only one member of their entire army survives. This lone soldier flees  \n to the island kingdom of Lanka and begs Surphanaka's brother, the mighty king Ravana\n\ngreat joy, Ram nor only lifted the bow, but was strong enough to break it as well. News  \n of Ram's forthcoming wedding was sent to Ayodhya. King Dasharat was overjoyed at  \n the news and arrived for the celebrations. After the festivities were over, Ram, Sita and  \n Dasharat returned home where all Ayodhya waited to greet them and more feasting and  \n merriment took place to welcome Sita. Finally, a brother of Queen Kaikeyi spoke to  \n Dasharat. 'My father wishes his grandson Bharat to return with me to live in our kingdom  for several years and learn about our customs. ow that the festivities are over, Your  \n Majesty, may I take Bharat home with me?'  \n Reluctantly Dasharat agreed and Bharat left for his grandfather's court.  \n The years went by and Ram proved to be a kind husband. Sita was a devoted wife and  \n the two were deeply in love. Dasharat missed Bharat and longed to see him, yet one  \n matter worried him constantly: Ram must be declared king before Bharat's return,  \n because Dasharat wanted to avoid any arguments about which brother should become  \n the new king. The elderly king called a council of ministers, sages and allied kings and\n\nQuestion: Who was Bharata's mother and what did she resents?\nHelpful Answer: Bharata's mother was Kaikeyi, and she resented Rama being the crown prince.")],
#  'answer': "Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.\n\nwas utterly worn down. He was distressed by the idea of losing his beloved son in his  \n own old age, and could not bring himself to speak to Ram when the young prince came  \n to get his blessing before the coronation.  \n Ram was concerned, 'Have I upset my father'' he wondered, then looking at Kaikeyi's  \n harsh expression, he asked.  \n 'Have I displeased the king' Tell me mother, why does my father looks so dejected''  \n 'Then listen, Ram,' replied Kaikeyi sternly. 'Your father loves you more than even his  \n honour so he hesitates to command you to go into exile for fourteen years, while Bharat  \n is crowned and established king of Ayodhya.' 'Thank you for telling me mother,' Ram  \n said. 'There is no greater virtue than to obey one's parents. I will leave immediately.  \n Bharat will make an able king.'  \n Ram sadly said farewell to his heartbroken father and then went to Queen Kaushaliya,  \n his real mother, to say goodbye to her. He explained how the decision had come about  \n and begged her to be kind to Dasharat who was deeply unhappy at Ram's exile.  \n Although grief-stricken, Kaushaliya agreed with Ram, praying for his happiness in exile.\n\nBharat will make an able king.'  \n Ram sadly said farewell to his heartbroken father and then went to Queen Kaushaliya,  \n his real mother, to say goodbye to her. He explained how the decision had come about  \n and begged her to be kind to Dasharat who was deeply unhappy at Ram's exile.  \n Although grief-stricken, Kaushaliya agreed with Ram, praying for his happiness in exile.  \n Then Ram went to say goodbye to Sita and to comfort her but Sita refused to be  \n separated from her husband.  \n 'If you can to live in hardship away from home and your beloved family,' she said, 'then I  \n will go with you. How can I be happy living in luxury without you'' His brother Lakshman  \n also refused to stay behind and that very day they left the kingdom. Ram led the way,  \n dressed like a holy man, with tangled hair and a leopard skin to cover his body. The  \n only sign that he was a warrior was the quiver of arrows which hung from his shoulder  \n and his precious bow.  \n The three left the city of Ayodhya and made their way across the River Ganges and up  \n into the mountains and forests of the Himalayas where they lived a holy life, filled with  \n fasting and prayer.\n\nRamayana Short Summary  \n  \n Dasharatha is the King of Ayodhya and has three wives and four sons, Rama,  \n Lakshmana, Bharata and Shatrughana. Rama is the ideal and perfect son, and grows  \n up with his brothers. When he comes of age, he marries Sita, the princess of a nearby  \n kingdom. However, Bharata's mother is Kaikeyi, who resents Rama being the crown  \n prince. She calls up a debt that Dasharatha owes her and asks for Rama to be exiled  \n for fourteen years and her son Bharata be made crown prince instead.  \n The devastated Dasharatha has no choice and Rama prepares to leave for exile. Sita  \n and Lakshmana will not leave his side however and follow him into the forest. While in  \n the forest, Surphanaka, a female rakshasi (demoness) becomes enamored of Rama  \n and is wounded by Lakshmana while trying to kill Sita. She flees to her brother Khara  \n and asks him to avenge her. However, Khara and his army are defeated by Rama and  \n Lakshmana, and only one member of their entire army survives. This lone soldier flees  \n to the island kingdom of Lanka and begs Surphanaka's brother, the mighty king Ravana\n\ngreat joy, Ram nor only lifted the bow, but was strong enough to break it as well. News  \n of Ram's forthcoming wedding was sent to Ayodhya. King Dasharat was overjoyed at  \n the news and arrived for the celebrations. After the festivities were over, Ram, Sita and  \n Dasharat returned home where all Ayodhya waited to greet them and more feasting and  \n merriment took place to welcome Sita. Finally, a brother of Queen Kaikeyi spoke to  \n Dasharat. 'My father wishes his grandson Bharat to return with me to live in our kingdom  for several years and learn about our customs. ow that the festivities are over, Your  \n Majesty, may I take Bharat home with me?'  \n Reluctantly Dasharat agreed and Bharat left for his grandfather's court.  \n The years went by and Ram proved to be a kind husband. Sita was a devoted wife and  \n the two were deeply in love. Dasharat missed Bharat and longed to see him, yet one  \n matter worried him constantly: Ram must be declared king before Bharat's return,  \n because Dasharat wanted to avoid any arguments about which brother should become  \n the new king. The elderly king called a council of ministers, sages and allied kings and\n\nQuestion: Who was Bharata's mother and what did she resents?\nHelpful Answer: Bharata's mother was Kaikeyi, and she resented Rama being the crown prince."}